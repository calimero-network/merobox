name: CI - Format Check & Merobox Integration Testing

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check code formatting
        run: |
          make format-check

      - name: Show formatting differences on failure
        if: failure()
        run: |
          echo "‚ùå Code formatting check failed!"
          echo "üí° To fix locally, run: make format"
          echo "üìã Showing differences:"
          make format-check || true

  test-merobox:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install merobox in development mode
        run: |
          pip install -e .

      - name: Install merod binary (specific release)
        run: |
          echo "Downloading merod binary from specific release..."

          # Use specific release version
          VERSION="0.10.0-rc.20"
          echo "Using version: $VERSION"

          ARCH="x86_64"
          PLATFORM="unknown-linux-gnu"
          TARBALL="merod_${ARCH}-${PLATFORM}.tar.gz"
          DOWNLOAD_URL="https://github.com/calimero-network/core/releases/download/${VERSION}/${TARBALL}"

          # Download and extract
          curl -L -o "${TARBALL}" "${DOWNLOAD_URL}"
          tar -xzf "${TARBALL}"
          chmod +x merod

          # Move to a directory in PATH
          sudo mv merod /usr/local/bin/
          rm "${TARBALL}"

          # Verify installation
          merod --version
          echo "merod installed successfully!"

      - name: Test merobox CLI and workflow (All workflows)
        run: |
          merobox --version
          merobox --help
          # Initial cleanup to ensure no leftover data from previous runs
          echo "üßπ Performing initial cleanup..."
          merobox stop --all --no-docker || true
          merobox nuke -f || true
          # Run all workflows for comprehensive testing on both PRs and master
          for f in workflow-examples/*.yml; do \
            echo "Running workflow: $f"; \
            merobox bootstrap run "$f" --no-docker --verbose; \
            echo "Cleaning up after workflow..."; \
            merobox stop --all --no-docker || true; \
            merobox nuke -f || true; \
          done

  test-merobox-docker:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Docker
        uses: docker/setup-buildx-action@v3

      - name: Start Docker daemon
        run: |
          sudo systemctl start docker
          sudo docker --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install merobox in development mode
        run: |
          pip install -e .

      - name: Test merobox CLI and workflow with Docker (All workflows)
        run: |
          merobox --version
          merobox --help
          # Initial cleanup to ensure no leftover data from previous runs
          echo "üßπ Performing initial cleanup..."
          merobox stop --all || true
          merobox nuke -f || true
          # Run all workflows with Docker for comprehensive testing
          for f in workflow-examples/*.yml; do \
            echo "Running workflow with Docker: $f"; \
            merobox bootstrap run "$f" --verbose; \
            echo "Cleaning up after workflow..."; \
            merobox stop --all || true; \
            merobox nuke -f || true; \
          done

  test-merobox-integration:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Docker
        uses: docker/setup-buildx-action@v3

      - name: Start Docker daemon
        run: |
          sudo systemctl start docker
          sudo docker --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install merobox in development mode
        run: |
          pip install -e .

      - name: Install example project dependencies
        run: |
          cd example-project
          pip install -r requirements.txt

      - name: Run merobox integration tests
        run: |
          # Initial cleanup to ensure no containers from previous runs
          echo "Performing initial cleanup..."
          merobox stop --all || true
          merobox nuke -f || true
          cd example-project
          echo "üß™ Running merobox integration test suite..."

          echo "üß™ Running merobox integration tests..."
          python -m pytest tests/test_merobox_integration.py -v --tb=short

          echo "‚úÖ All merobox integration tests completed successfully!"
          echo "Cleaning up after integration tests..."
          cd .. && merobox stop --all || true
          merobox nuke -f || true
