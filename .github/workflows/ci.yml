name: CI - Format Check & Merobox Integration Testing

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.13"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Check code formatting
      run: |
        make format-check
    
    - name: Show formatting differences on failure
      if: failure()
      run: |
        echo "‚ùå Code formatting check failed!"
        echo "üí° To fix locally, run: make format"
        echo "üìã Showing differences:"
        make format-check || true

  test-merobox:
    runs-on: ubuntu-latest
    needs: format
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.13"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install merobox in development mode
      run: |
        pip install -e .
    
    - name: Test merobox CLI and workflow
      run: |
        merobox --version
        merobox --help
        merobox bootstrap run workflow-examples/workflow-example.yml --verbose

  test-merobox-integration:
    runs-on: ubuntu-latest
    needs: format
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.13"
    
    - name: Install Docker
      uses: docker/setup-buildx-action@v3
    
    - name: Start Docker daemon
      run: |
        sudo systemctl start docker
        sudo docker --version
    
    - name: Install example project dependencies
      working-directory: ./example-project
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    
    - name: Run merobox integration tests
      working-directory: ./example-project
      run: |
        echo "üß™ Running merobox integration test suite..."
        
        echo "üß™ Running merobox integration tests..."
        python -m pytest tests/test_merobox_integration.py -v --tb=short
        
        echo "‚úÖ All merobox integration tests completed successfully!"
    