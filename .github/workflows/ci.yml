name: CI - Format Check & Merobox Integration Testing

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  # Or you can use 'prerelease-{PR-NUMBER}'
  CALIMERO_CONTRACTS_VERSION: "latest"
  MEROD_BINARY_VERSION: "edge"

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check code formatting
        run: |
          make format-check

      - name: Show formatting differences on failure
        if: failure()
        run: |
          echo "‚ùå Code formatting check failed!"
          echo "üí° To fix locally, run: make format"
          echo "üìã Showing differences:"
          make format-check || true

  test-merobox:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install merobox in development mode
        run: |
          pip install -e .

      - name: Install merod binary (edge)
        run: |
          echo "Downloading merod binary..."
          VERSION="${MEROD_BINARY_VERSION:-edge}"
          if [ "$VERSION" = "edge" ]; then
            echo "Resolving edge merod release tag..."
            VERSION=$(python - <<'PY'
          import json
          import urllib.request

          url = "https://api.github.com/repos/calimero-network/core/releases"
          with urllib.request.urlopen(url) as resp:
              releases = json.load(resp)

          for release in releases:
              if release.get("draft"):
                  continue
              print(release.get("tag_name", ""))
              break
          PY
            )
          fi

          if [ -z "$VERSION" ]; then
            echo "Failed to resolve merod release tag"
            exit 1
          fi
          echo "Using version: $VERSION"

          ARCH="x86_64"
          PLATFORM="unknown-linux-gnu"
          TARBALL="merod_${ARCH}-${PLATFORM}.tar.gz"
          DOWNLOAD_URL="https://github.com/calimero-network/core/releases/download/${VERSION}/${TARBALL}"

          # Download and extract
          curl -L -o "${TARBALL}" "${DOWNLOAD_URL}"
          tar -xzf "${TARBALL}"
          chmod +x merod

          # Move to a directory in PATH
          sudo mv merod /usr/local/bin/
          rm "${TARBALL}"

          # Verify installation
          merod --version
          echo "merod installed successfully!"

      - name: Download Context contracts
        run: |
          echo "Downloading contracts, target version: $CALIMERO_CONTRACTS_VERSION"
          ./workflow-examples/scripts/download_contracts.sh

      - name: Test merobox CLI and workflow (All workflows)
        run: |
          merobox --version
          merobox --help

          failed_workflows=()

          # Run all workflows (exclude fuzzy-kv-store)
          for f in workflow-examples/*.yml; do
            [[ "$f" == "workflow-examples/workflow-fuzzy-kv-store.yml" ]] && continue
            echo "Running workflow: $f"
            if ! merobox bootstrap run "$f" \
              --no-docker \
              --e2e-mode \
              --near-devnet \
              --contracts-dir "$GITHUB_WORKSPACE/contracts/near"; then
              failed_workflows+=("$f")
            fi
            merobox stop --all --no-docker || true
            merobox nuke -f || true
          done

          # Retry failed workflows (max 2 retries)
          for retry in 1 2; do
            [ ${#failed_workflows[@]} -eq 0 ] && break
            echo "Retry $retry for ${#failed_workflows[@]} failed workflow(s)..."
            sleep 2
            
            still_failed=()
            for f in "${failed_workflows[@]}"; do
              if ! merobox bootstrap run "$f" \
                --no-docker \
                --binary-path ../../target/debug/merod \
                --e2e-mode \
                --near-devnet \
                --contracts-dir "$GITHUB_WORKSPACE/contracts/near"; then
                still_failed+=("$f")
              fi
              merobox stop --all --no-docker || true
              merobox nuke -f || true
              sleep 2
            done
            failed_workflows=("${still_failed[@]}")
          done

          # Exit if any workflows still failed
          if [ ${#failed_workflows[@]} -gt 0 ]; then
            echo "Failed workflows: ${failed_workflows[*]}"
            exit 1
          fi
          echo "All workflows passed!"

  test-merobox-docker:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Docker
        uses: docker/setup-buildx-action@v3

      - name: Start Docker daemon
        run: |
          sudo systemctl start docker
          sudo docker --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install merobox in development mode
        run: |
          pip install -e .

      - name: Download Context contracts
        run: |
          echo "Downloading contracts, target version: $CALIMERO_CONTRACTS_VERSION"
          ls -la
          pwd
          ./workflow-examples/scripts/download_contracts.sh

      - name: Test merobox CLI and workflow with Docker (All workflows)
        run: |
          merobox --version
          merobox --help

          failed_workflows=()

          # Run all workflows with Docker (skip binary-only workflow and fuzzy-kv-store)
          for f in workflow-examples/*.yml; do
            [[ "$f" == "workflow-examples/workflow-example-binary.yml" ]] && continue
            [[ "$f" == "workflow-examples/workflow-fuzzy-kv-store.yml" ]] && continue
            echo "Running workflow: $f"
            if ! merobox bootstrap run "$f" \
              --e2e-mode \
              --near-devnet \
              --contracts-dir "$GITHUB_WORKSPACE/contracts/near"; then
              failed_workflows+=("$f")
            fi
            merobox stop --all || true
            merobox nuke -f || true
          done

          # Retry failed workflows (max 2 retries)
          for retry in 1 2; do
            [ ${#failed_workflows[@]} -eq 0 ] && break
            echo "Retry $retry for ${#failed_workflows[@]} failed workflow(s)..."
            sleep 2
            
            still_failed=()
            for f in "${failed_workflows[@]}"; do
              if ! merobox bootstrap run "$f" \
                --e2e-mode \
                --near-devnet \
                --contracts-dir "$GITHUB_WORKSPACE/contracts/near"; then
                still_failed+=("$f")
              fi
              merobox stop --all || true
              merobox nuke -f || true
              sleep 2
            done
            failed_workflows=("${still_failed[@]}")
          done

          # Exit if any workflows still failed
          if [ ${#failed_workflows[@]} -gt 0 ]; then
            echo "Failed workflows: ${failed_workflows[*]}"
            exit 1
          fi
          echo "All workflows passed!"

  test-merobox-integration:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Docker
        uses: docker/setup-buildx-action@v3

      - name: Start Docker daemon
        run: |
          sudo systemctl start docker
          sudo docker --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install merobox in development mode
        run: |
          pip install -e .

      - name: Install example project dependencies
        run: |
          cd example-project
          pip install -r requirements.txt

      - name: Download Context contracts
        run: |
          echo "Downloading contracts, target version: $CALIMERO_CONTRACTS_VERSION"
          ./workflow-examples/scripts/download_contracts.sh

      - name: Run merobox integration tests
        run: |
          # Initial cleanup to ensure no containers from previous runs
          echo "Performing initial cleanup..."
          merobox stop --all || true
          merobox nuke -f || true
          cd example-project
          echo "üß™ Running merobox integration test suite..."

          echo "üß™ Running merobox integration tests..."
          python -m pytest tests/test_merobox_integration.py -v --tb=short

          echo "‚úÖ All merobox integration tests completed successfully!"
          echo "Cleaning up after integration tests..."
          cd .. && merobox stop --all || true
          merobox nuke -f || true
