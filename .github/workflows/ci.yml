name: CI - Format Check & Merobox Integration Testing

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  # Or you can use 'prerelease-{PR-NUMBER}'
  CALIMERO_CONTRACTS_VERSION: "latest"

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check code formatting
        run: |
          make format-check

      - name: Show formatting differences on failure
        if: failure()
        run: |
          echo "‚ùå Code formatting check failed!"
          echo "üí° To fix locally, run: make format"
          echo "üìã Showing differences:"
          make format-check || true

  test-merobox:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install merobox in development mode
        run: |
          pip install -e .

      - name: Install merod binary (specific release)
        run: |
          echo "Downloading merod binary from specific release..."

          # Use specific release version
          VERSION="0.10.0-rc.39"
          echo "Using version: $VERSION"

          ARCH="x86_64"
          PLATFORM="unknown-linux-gnu"
          TARBALL="merod_${ARCH}-${PLATFORM}.tar.gz"
          DOWNLOAD_URL="https://github.com/calimero-network/core/releases/download/${VERSION}/${TARBALL}"

          # Download and extract
          curl -L -o "${TARBALL}" "${DOWNLOAD_URL}"
          tar -xzf "${TARBALL}"
          chmod +x merod

          # Move to a directory in PATH
          sudo mv merod /usr/local/bin/
          rm "${TARBALL}"

          # Verify installation
          merod --version
          echo "merod installed successfully!"

      - name: Set up Rust (wasm32 target for workflow apps)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Build workflow WASM apps (kv_store, blobs from calimero-network/core)
        run: |
          chmod +x workflow-examples/scripts/build_res_wasm.sh
          ./workflow-examples/scripts/build_res_wasm.sh

      - name: Test merobox CLI and workflow (All workflows)
        run: |
          merobox --version
          merobox --help

          # Binary mode: do not pass --binary-path; merod is installed to /usr/local/bin (PATH).
          # Workflow YAMLs must not set binary_path to a path that doesn't exist in CI.

          failed_workflows=()

          # Run all workflows (exclude fuzzy-kv-store)
          for f in workflow-examples/*.yml; do
            [[ "$f" == "workflow-examples/workflow-fuzzy-kv-store.yml" ]] && continue
            echo "Running workflow: $f"
            if ! merobox bootstrap run "$f" \
              --no-docker \
              --e2e-mode; then
              failed_workflows+=("$f")
            fi
            merobox stop --all --no-docker || true
            merobox nuke -f || true
          done

          # Retry failed workflows (max 2 retries); use same args as first run (merod from PATH)
          for retry in 1 2; do
            [ ${#failed_workflows[@]} -eq 0 ] && break
            echo "Retry $retry for ${#failed_workflows[@]} failed workflow(s)..."
            sleep 2
            
            still_failed=()
            for f in "${failed_workflows[@]}"; do
              if ! merobox bootstrap run "$f" \
                --no-docker \
                --e2e-mode; then
                still_failed+=("$f")
              fi
              merobox stop --all --no-docker || true
              merobox nuke -f || true
              sleep 2
            done
            failed_workflows=("${still_failed[@]}")
          done

          # Exit if any workflows still failed
          if [ ${#failed_workflows[@]} -gt 0 ]; then
            echo "Failed workflows: ${failed_workflows[*]}"
            exit 1
          fi
          echo "All workflows passed!"

  test-merobox-docker:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Docker
        uses: docker/setup-buildx-action@v3

      - name: Start Docker daemon
        run: |
          sudo systemctl start docker
          sudo docker --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install merobox in development mode
        run: |
          pip install -e .

      - name: Set up Rust (wasm32 target for workflow apps)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Build workflow WASM apps (kv_store, blobs from calimero-network/core)
        run: |
          chmod +x workflow-examples/scripts/build_res_wasm.sh
          ./workflow-examples/scripts/build_res_wasm.sh

      - name: Test merobox CLI and workflow with Docker (All workflows)
        run: |
          merobox --version
          merobox --help

          failed_workflows=()

          # Run all workflows with Docker (skip binary-only, fuzzy-kv-store)
          for f in workflow-examples/*.yml; do
            [[ "$f" == "workflow-examples/workflow-example-binary.yml" ]] && continue
            [[ "$f" == "workflow-examples/workflow-fuzzy-kv-store.yml" ]] && continue
            echo "Running workflow: $f"
            if ! merobox bootstrap run "$f" \
              --e2e-mode; then
              failed_workflows+=("$f")
            fi
            merobox stop --all || true
            merobox nuke -f || true
          done

          # Retry failed workflows (max 2 retries)
          for retry in 1 2; do
            [ ${#failed_workflows[@]} -eq 0 ] && break
            echo "Retry $retry for ${#failed_workflows[@]} failed workflow(s)..."
            sleep 2
            
            still_failed=()
            for f in "${failed_workflows[@]}"; do
              if ! merobox bootstrap run "$f" \
                --e2e-mode; then
                still_failed+=("$f")
              fi
              merobox stop --all || true
              merobox nuke -f || true
              sleep 2
            done
            failed_workflows=("${still_failed[@]}")
          done

          # Exit if any workflows still failed
          if [ ${#failed_workflows[@]} -gt 0 ]; then
            echo "Failed workflows: ${failed_workflows[*]}"
            exit 1
          fi
          echo "All workflows passed!"

  test-merobox-integration:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Docker
        uses: docker/setup-buildx-action@v3

      - name: Start Docker daemon
        run: |
          sudo systemctl start docker
          sudo docker --version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install merobox in development mode
        run: |
          pip install -e .

      - name: Install example project dependencies
        run: |
          cd example-project
          pip install -r requirements.txt

      - name: Run merobox integration tests
        run: |
          # Initial cleanup to ensure no containers from previous runs
          echo "Performing initial cleanup..."
          merobox stop --all || true
          merobox nuke -f || true
          cd example-project
          echo "üß™ Running merobox integration test suite..."

          echo "üß™ Running merobox integration tests..."
          python -m pytest tests/test_merobox_integration.py -v --tb=short

          echo "‚úÖ All merobox integration tests completed successfully!"
          echo "Cleaning up after integration tests..."
          cd .. && merobox stop --all || true
          merobox nuke -f || true
