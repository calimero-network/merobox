name: Test DEB Package

on:
  pull_request:
    branches: [master]

jobs:
  test-deb-package:
    name: Test .deb package installation and runtime
    runs-on: ubuntu-24.04-8cpu
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential dpkg-dev

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          pyinstaller merobox.spec
          ./dist/merobox --version

      - name: Determine version
        id: version
        run: |
          VERSION=$(grep '^__version__ = ' merobox/__init__.py | sed 's/__version__ = "\(.*\)"/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Build .deb package
        run: |
          chmod +x packaging/apt/build-deb.sh
          mkdir -p debs
          OUTPUT_DIR=debs ./packaging/apt/build-deb.sh "${{ steps.version.outputs.version }}" ./dist/merobox amd64

      - name: Install .deb package
        run: |
          echo "=== Installing .deb package ==="
          sudo dpkg -i debs/*.deb || sudo apt-get install -f -y
          dpkg -l | grep merobox

      - name: Test merobox --version
        run: |
          echo "=== Testing merobox --version ==="
          merobox --version

      - name: Install merod binary (latest prerelease)
        run: |
          echo "Downloading merod binary from latest prerelease..."
          VERSION=$(curl -sL https://api.github.com/repos/calimero-network/core/releases | jq -r '[.[] | select(.prerelease == true)][0].tag_name')
          if [[ "$VERSION" == "null" || -z "$VERSION" ]]; then
            echo "Could not resolve latest prerelease (no prereleases or API error). VERSION=$VERSION"
            exit 1
          fi
          echo "Using merod version: $VERSION"
          ARCH="x86_64"
          PLATFORM="unknown-linux-gnu"
          TARBALL="merod_${ARCH}-${PLATFORM}.tar.gz"
          DOWNLOAD_URL="https://github.com/calimero-network/core/releases/download/${VERSION}/${TARBALL}"
          curl -fSL -o "${TARBALL}" "${DOWNLOAD_URL}"
          tar -xzf "${TARBALL}"
          chmod +x merod
          sudo mv merod /usr/local/bin/
          rm "${TARBALL}"
          merod --version

      - name: Set up Rust (wasm32 target for workflow apps)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Build workflow WASM apps (kv_store, blobs, blockchain from calimero-network/core)
        run: |
          chmod +x workflow-examples/scripts/build_res_wasm.sh
          ./workflow-examples/scripts/build_res_wasm.sh

      - name: Test merobox bootstrap run workflow
        run: |
          echo "=== Testing merobox bootstrap run workflow-example.yml ==="
          # Use --no-enable-relayer so nodes use local sandbox only (no relayer); more reliable sync in CI
          for attempt in 1 2; do
            echo "Attempt $attempt/2..."
            if merobox bootstrap run workflow-examples/workflow-example.yml \
              --no-docker \
              --e2e-mode \
              --no-enable-relayer; then
              echo "Workflow completed successfully"
              exit 0
            fi
            merobox stop --all --no-docker || true
            merobox nuke -f || true
            [ "$attempt" -eq 1 ] && echo "First attempt failed, retrying..." || true
          done
          echo "Workflow failed after 2 attempts"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          merobox stop --all --no-docker || true
          merobox nuke -f || true
          sudo dpkg -r merobox || true
