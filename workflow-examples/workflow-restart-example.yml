description: A workflow example demonstrating the restart flag functionality
name: Restart Flag Example Workflow

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: calimero-node

steps:
  # Step 1: Install the application on the first node
  - name: Install Application on Node 1
    type: install_application
    node: calimero-node-1
    path: ./workflow-examples/res/kv_store.wasm
    dev: true
    outputs:
      app_id: applicationId         # Export 'applicationId' field as 'app_id'

  # Step 2: Create a context using the installed application
  - name: Create Context on Node 1
    type: create_context
    node: calimero-node-1
    application_id: '{{app_id}}'
    outputs:
      context_id: contextId         # Export 'contextId' field as 'context_id'
      member_public_key: memberPublicKey  # Export 'memberPublicKey' as 'member_public_key'

  # Step 3: Generate an identity on the second node
  - name: Create Identity on Node 2
    type: create_identity
    node: calimero-node-2
    outputs:
      public_key: publicKey         # Export 'publicKey' as 'public_key'

  # Step 4: Wait for identity creation to complete
  - name: Wait for Identity Creation
    type: wait
    seconds: 5

  # Step 5: Invite the second node to join the context
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: calimero-node-1
    context_id: '{{context_id}}'
    grantee_id: '{{public_key}}'
    granter_id: '{{member_public_key}}'
    capability: member
    outputs:
      invitation: invitation         # Export 'invitation' as 'invitation'

  # Step 6: Join the context from the second node
  - name: Join Context from Node 2
    type: join_context
    node: calimero-node-2
    context_id: '{{context_id}}'
    invitee_id: '{{public_key}}'
    invitation: '{{invitation}}'

  # Step 7: Execute a contract call to set a key-value pair
  - name: Execute Contract Call - Set Key-Value
    type: call
    node: calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: set
    args:
      key: hello
      value: world
    outputs:
      set_result: result            # Export 'result' as 'set_result'

  # Step 8: Wait for the set operation to complete and propagate
  - name: Wait for Set Operation
    type: wait
    seconds: 3

  # Step 9: Execute a view call to retrieve the stored value
  - name: Execute View Call - Get Value
    type: call
    node: calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key}}'
    method: get
    args:
      key: hello
    outputs:
      get_result: result            # Export 'result' as 'get_result'

# Configuration options
stop_all_nodes: false  # Don't stop all nodes at the end of workflow
restart: false          # Don't restart nodes at the beginning of workflow
wait_timeout: 60

# Usage Examples:
# 
# 1. Fresh start workflow:
#    stop_all_nodes: true, restart: true
#    - This will restart nodes at the beginning and stop all at the end
#
# 2. Efficient rerun workflow:
#    stop_all_nodes: false, restart: false
#    - This will reuse existing nodes at the beginning and leave them running at the end
#
# 3. Restart but keep running:
#    stop_all_nodes: false, restart: true
#    - This will restart workflow nodes at the beginning but leave them running at the end
#
# 4. Full cleanup workflow:
#    stop_all_nodes: true, restart: true
#    - This will restart nodes at the beginning and stop all at the end
