description: Test snapshot sync by having Node 2 join after Node 1 has accumulated 5000 key/values
name: Snapshot Sync Test

force_pull_image: true
nuke_on_start: true
e2e_mode: true

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: snapshot-node

steps:
  # =============================================================================
  # PHASE 1: Setup Node 1 with application and context
  # =============================================================================

  - name: Install Application on Node 1
    type: install_application
    node: snapshot-node-1
    path: ./workflow-examples/res/kv_store.wasm
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context on Node 1
    type: create_context
    node: snapshot-node-1
    application_id: "{{app_id}}"
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Assert Context Created
    type: assert
    statements:
      - "is_set({{context_id}})"
      - "is_set({{member_public_key}})"

  # =============================================================================
  # PHASE 2: Write 5000 key/value pairs on Node 1 (bulk data for snapshot sync)
  # =============================================================================

  - name: "[Bulk Write] Writing 5000 key/value pairs on Node 1 (parallel)"
    type: parallel
    mode: burst
    groups:
      - name: Bulk_Write_Operations
        count: 5000
        steps:
          - name: "Write key {{iteration}}"
            type: call
            node: snapshot-node-1
            context_id: "{{context_id}}"
            executor_public_key: "{{member_public_key}}"
            method: set
            args:
              key: "snapshot_key_{{iteration}}"
              value: "snapshot_value_{{iteration}}"

  - name: Verify last key written on Node 1
    type: call
    node: snapshot-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get
    args:
      key: "snapshot_key_5000"
    outputs:
      verify_node1_last_key: result

  - name: Assert last key exists on Node 1
    type: json_assert
    statements:
      - 'json_subset({{verify_node1_last_key}}, {"output": "snapshot_value_5000"})'

  # =============================================================================
  # PHASE 3: Node 2 joins context - should trigger snapshot sync
  # =============================================================================

  - name: Create Identity on Node 2
    type: create_identity
    node: snapshot-node-2
    outputs:
      public_key_node2: publicKey

  - name: Wait for Identity Creation
    type: wait
    seconds: 3

  - name: Invite Node 2 to Context
    type: invite_identity
    node: snapshot-node-1
    context_id: "{{context_id}}"
    grantee_id: "{{public_key_node2}}"
    granter_id: "{{member_public_key}}"
    capability: member
    outputs:
      invitation_node2: invitation

  - name: Node 2 Joins Context (triggers snapshot sync)
    type: join_context
    node: snapshot-node-2
    context_id: "{{context_id}}"
    invitee_id: "{{public_key_node2}}"
    invitation: "{{invitation_node2}}"

  # Wait for snapshot sync to complete
  - name: Wait for Snapshot Sync
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - snapshot-node-1
      - snapshot-node-2
    timeout: 300
    check_interval: 5
    trigger_sync: true
    outputs:
      sync_root_hash: root_hash
      sync_time: elapsed_seconds

  # =============================================================================
  # PHASE 4: Verify Node 2 has all 5000 keys via snapshot sync
  # =============================================================================

  - name: "[Verify Sync] Check first key on Node 2"
    type: call
    node: snapshot-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_node2}}"
    method: get
    args:
      key: "snapshot_key_1"
    outputs:
      verify_first_key: result

  - name: "[Verify Sync] Check middle key on Node 2"
    type: call
    node: snapshot-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_node2}}"
    method: get
    args:
      key: "snapshot_key_2500"
    outputs:
      verify_middle_key: result

  - name: "[Verify Sync] Check last key on Node 2"
    type: call
    node: snapshot-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_node2}}"
    method: get
    args:
      key: "snapshot_key_5000"
    outputs:
      verify_last_key: result

  - name: Assert Node 2 has synced all keys
    type: json_assert
    statements:
      - 'json_subset({{verify_first_key}}, {"output": "snapshot_value_1"})'
      - 'json_subset({{verify_middle_key}}, {"output": "snapshot_value_2500"})'
      - 'json_subset({{verify_last_key}}, {"output": "snapshot_value_5000"})'

  # =============================================================================
  # PHASE 5: Send more data from both nodes and verify cross-propagation
  # =============================================================================

  - name: "[Post-Sync] Node 1 writes new key"
    type: call
    node: snapshot-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: set
    args:
      key: "post_sync_from_node1"
      value: "written_by_node1_after_sync"

  - name: "[Post-Sync] Node 2 writes new key"
    type: call
    node: snapshot-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_node2}}"
    method: set
    args:
      key: "post_sync_from_node2"
      value: "written_by_node2_after_sync"

  - name: Wait for post-sync propagation
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - snapshot-node-1
      - snapshot-node-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  # Verify cross-propagation: Node 2 can read Node 1's new key
  - name: "[Verify Cross-Prop] Node 2 reads Node 1's new key"
    type: call
    node: snapshot-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_node2}}"
    method: get
    args:
      key: "post_sync_from_node1"
    outputs:
      node2_reads_node1_key: result

  # Verify cross-propagation: Node 1 can read Node 2's new key
  - name: "[Verify Cross-Prop] Node 1 reads Node 2's new key"
    type: call
    node: snapshot-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get
    args:
      key: "post_sync_from_node2"
    outputs:
      node1_reads_node2_key: result

  - name: Assert cross-propagation succeeded
    type: json_assert
    statements:
      - 'json_subset({{node2_reads_node1_key}}, {"output": "written_by_node1_after_sync"})'
      - 'json_subset({{node1_reads_node2_key}}, {"output": "written_by_node2_after_sync"})'

  # =============================================================================
  # PHASE 6: Final Summary
  # =============================================================================

  - name: Final Summary
    type: assert
    statements:
      - statement: "is_set({{context_id}})"
        message: "Context was created successfully"
      - statement: "is_set({{sync_root_hash}})"
        message: "Snapshot sync completed - nodes have matching root hash"
      - statement: "is_set({{node1_reads_node2_key}})"
        message: "Cross-propagation after snapshot sync works correctly"

stop_all_nodes: true
restart: false
wait_timeout: 600
